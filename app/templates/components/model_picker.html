{#
  Model Picker Component
  ──────────────────────
  Reusable model selector with per-model pricing and free tier highlighting.

  Expected context:
    models       — list from get_model_choices() (slug, display_name, icon, cheapest_price, has_free_tier, providers, …)
    selected     — currently selected model slug (default: first model)
    field_name   — hidden input name (default: "model")
    picker_id    — unique id prefix for JS (default: "model-picker")
    show_provider — whether to show provider sub-selector (default: false)
#}

{% set models = models | default([]) %}
{% set selected = selected | default(models[0].slug if models else '') %}
{% set field_name = field_name | default('model') %}
{% set picker_id = picker_id | default('model-picker') %}
{% set show_provider = show_provider | default(false) %}

<!-- Hidden inputs to carry model + provider values -->
<input type="hidden" name="{{ field_name }}" id="{{ picker_id }}-input" value="{{ selected }}">
{% if show_provider %}
<input type="hidden" name="provider" id="{{ picker_id }}-provider-input" value="">
{% endif %}

<div id="{{ picker_id }}" class="space-y-2">
    <!-- Model Cards Grid -->
    <div class="grid grid-cols-1 gap-1.5">
        {% for m in models %}
        <button type="button"
                data-model="{{ m.slug }}"
                data-price="{{ '%.2f' | format(m.cheapest_price) }}"
                data-free="{{ 'true' if m.has_free_tier else 'false' }}"
                data-default-provider="{{ m.default_provider }}"
                onclick="selectModel_{{ picker_id | replace('-','_') }}(this, '{{ m.slug }}', '{{ m.default_provider }}')"
                class="model-card relative flex items-center w-full px-3 py-2.5 rounded-lg border-2 text-left transition-all
                       {{ 'border-[#F18523] bg-[#F18523]/5 dark:bg-[#F18523]/10' if m.slug == selected else 'border-[#26A0D8]/20 dark:border-[#26A0D8]/40 hover:border-[#26A0D8]/40 dark:hover:border-[#26A0D8]/60 bg-white dark:bg-[#1A1A1A]' }}">
            <!-- Icon -->
            <span class="text-lg mr-2.5 flex-shrink-0">{{ m.icon }}</span>

            <!-- Info -->
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-1.5">
                    <span class="text-xs font-semibold text-gray-800 dark:text-gray-100">{{ m.display_name }}</span>
                    {% if m.has_free_tier %}
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-700/50">
                        Free
                    </span>
                    {% endif %}
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-medium uppercase tracking-wider
                                 {{ 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400' if m.type == 'image' else 'bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400' }}">
                        {{ m.type | capitalize }}
                    </span>
                </div>
                <p class="text-[10px] text-gray-500 dark:text-gray-400 mt-0.5 truncate">{{ m.description }}</p>
            </div>

            <!-- Price -->
            <div class="flex-shrink-0 ml-2 text-right">
                {% if m.has_free_tier %}
                <span class="text-xs font-bold text-green-600 dark:text-green-400">$0.00</span>
                <span class="block text-[9px] text-gray-400">free tier</span>
                {% else %}
                <span class="text-xs font-bold text-gray-700 dark:text-gray-200">${{ '%.2f' | format(m.cheapest_price) }}</span>
                <span class="block text-[9px] text-gray-400">per gen</span>
                {% endif %}
            </div>

            <!-- Selected checkmark -->
            <div class="model-check absolute top-1.5 right-1.5 w-4 h-4 rounded-full bg-[#F18523] flex items-center justify-center {{ '' if m.slug == selected else 'hidden' }}">
                <svg class="w-2.5 h-2.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
        </button>

        {% if show_provider and m.providers | length > 1 %}
        <!-- Provider sub-selector (shown when model is selected) -->
        <div id="{{ picker_id }}-providers-{{ m.slug }}" class="provider-panel pl-8 space-y-1 {{ '' if m.slug == selected else 'hidden' }}">
            {% for p in m.providers %}
            <button type="button"
                    data-provider="{{ p.name }}"
                    onclick="selectProvider_{{ picker_id | replace('-','_') }}('{{ m.slug }}', '{{ p.name }}', this)"
                    class="provider-btn flex items-center w-full px-2.5 py-1.5 rounded-md border text-left text-[11px] transition-all
                           {{ 'border-[#F18523]/50 bg-[#F18523]/5' if p.name == m.default_provider and m.slug == selected else 'border-[#26A0D8]/10 dark:border-[#26A0D8]/20 hover:border-[#26A0D8]/30' }}">
                <span class="flex-1 font-medium text-gray-700 dark:text-gray-300">{{ p.label }}</span>
                {% if p.free_tier %}
                <span class="px-1 py-0.5 text-[8px] font-bold bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded mr-1.5">FREE</span>
                {% endif %}
                {% if p.sync %}
                <span class="px-1 py-0.5 text-[8px] font-medium bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 rounded mr-1.5">Instant</span>
                {% endif %}
                <span class="text-[11px] font-semibold {{ 'text-green-600 dark:text-green-400' if p.free_tier else 'text-gray-600 dark:text-gray-300' }}">
                    ${{ '%.2f' | format(p.retail) }}
                </span>
            </button>
            {% endfor %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>

<script>
(function() {
    var pickerId = '{{ picker_id }}';
    var showProvider = {{ 'true' if show_provider else 'false' }};

    // Attach to window so onclick attributes can find them
    window['selectModel_{{ picker_id | replace("-","_") }}'] = function(btn, slug, defaultProvider) {
        var container = document.getElementById(pickerId);
        if (!container) return;

        // Update hidden input
        document.getElementById(pickerId + '-input').value = slug;

        // Update card styles
        container.querySelectorAll('.model-card').forEach(function(card) {
            card.classList.remove('border-[#F18523]', 'bg-[#F18523]/5', 'dark:bg-[#F18523]/10');
            card.classList.add('border-[#26A0D8]/20', 'dark:border-[#26A0D8]/40');
            var chk = card.querySelector('.model-check');
            if (chk) chk.classList.add('hidden');
        });
        btn.classList.remove('border-[#26A0D8]/20', 'dark:border-[#26A0D8]/40');
        btn.classList.add('border-[#F18523]', 'bg-[#F18523]/5', 'dark:bg-[#F18523]/10');
        var chk = btn.querySelector('.model-check');
        if (chk) chk.classList.remove('hidden');

        // Show/hide provider panels
        if (showProvider) {
            container.querySelectorAll('.provider-panel').forEach(function(panel) {
                panel.classList.add('hidden');
            });
            var panel = document.getElementById(pickerId + '-providers-' + slug);
            if (panel) panel.classList.remove('hidden');

            // Set default provider
            document.getElementById(pickerId + '-provider-input').value = defaultProvider;
        }

        // Update price badge on generate button (if present)
        var priceEl = document.getElementById(pickerId + '-price-badge');
        if (priceEl) {
            var isFree = btn.dataset.free === 'true';
            priceEl.textContent = isFree ? '$0.00' : ('$' + btn.dataset.price);
        }
    };

    window['selectProvider_{{ picker_id | replace("-","_") }}'] = function(modelSlug, providerName, btn) {
        if (!showProvider) return;
        document.getElementById(pickerId + '-provider-input').value = providerName;

        // Highlight selected provider button
        var panel = document.getElementById(pickerId + '-providers-' + modelSlug);
        if (panel) {
            panel.querySelectorAll('.provider-btn').forEach(function(pb) {
                pb.classList.remove('border-[#F18523]/50', 'bg-[#F18523]/5');
                pb.classList.add('border-[#26A0D8]/10', 'dark:border-[#26A0D8]/20');
            });
            btn.classList.remove('border-[#26A0D8]/10', 'dark:border-[#26A0D8]/20');
            btn.classList.add('border-[#F18523]/50', 'bg-[#F18523]/5');
        }
    };
})();
</script>
