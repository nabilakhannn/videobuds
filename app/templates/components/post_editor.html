{# Post Editor Side Panel - Loaded via HTMX into #editor-content #}
{# Expected context: post, campaign, day #}

{% set status = post.status if post and post.status else 'draft' %}

<div class="space-y-5">
    <!-- Image Preview -->
    <div class="relative rounded-lg overflow-hidden bg-gray-50 dark:bg-[#2A2A2A]/50">
        {% if post and post.image_url %}
        <img src="{{ post.image_url }}" alt="Day {{ day }} image"
             class="w-full aspect-square object-cover">
        {% else %}
        <div class="w-full aspect-square flex flex-col items-center justify-center">
            <svg class="w-12 h-12 text-gray-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p class="text-sm text-gray-500">No image generated</p>
        </div>
        {% endif %}

        <!-- Status Badge Overlay -->
        <div class="absolute top-2 right-2">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium backdrop-blur-sm
                        {{ 'bg-gray-100/70 dark:bg-[#1E1E1E]/70 text-gray-600 dark:text-gray-300' if status == 'draft' else '' }}
                        {{ 'bg-yellow-900/70 text-yellow-300' if status == 'generating' else '' }}
                        {{ 'bg-green-900/70 text-green-300' if status == 'generated' else '' }}
                        {{ 'bg-blue-900/70 text-blue-300' if status == 'approved' else '' }}
                        {{ 'bg-red-900/70 text-red-300' if status == 'rejected' else '' }}">
                {% if status == 'generating' %}
                <span class="w-1.5 h-1.5 rounded-full bg-yellow-400 mr-1.5 generating-pulse"></span>
                {% endif %}
                {{ status|capitalize }}
            </span>
        </div>
    </div>

    <!-- Caption -->
    <form id="post-form" method="POST"
          action="{{ url_for('posts.update_post', campaign_id=campaign.id, day=day) }}"
          hx-post="{{ url_for('posts.update_post', campaign_id=campaign.id, day=day) }}"
          hx-target="#editor-content"
          hx-swap="innerHTML">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="space-y-4">
            <!-- Caption Field -->
            <div>
                <div class="flex items-center justify-between mb-1.5">
                    <label for="caption" class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Caption</label>
                    {% if post and post.id %}
                    <button type="button"
                            hx-post="{{ url_for('api.agent_suggest_captions', post_id=post.id) }}"
                            hx-target="#caption-suggestions"
                            hx-swap="innerHTML"
                            hx-indicator="#caption-ai-spinner"
                            class="inline-flex items-center px-2 py-1 text-[10px] font-medium text-[#F18523] hover:text-white bg-[#F18523]/10 hover:bg-[#F18523]/20 rounded border border-[#F18523]/20 transition-colors">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        AI Suggest
                        <span id="caption-ai-spinner" class="htmx-indicator ml-1">
                            <span class="w-2.5 h-2.5 border border-[#F18523] border-t-transparent rounded-full animate-spin inline-block"></span>
                        </span>
                    </button>
                    {% endif %}
                </div>
                <textarea id="caption" name="caption" rows="4"
                          class="w-full px-3 py-2 bg-white dark:bg-[#141414] border border-[#26A0D8]/30 rounded-lg text-sm text-gray-900 dark:text-white placeholder-gray-400
                                 focus:outline-none focus:ring-2 focus:ring-[#F18523] focus:border-transparent transition-colors resize-none"
                          placeholder="Write your caption...">{{ post.caption if post and post.caption else '' }}</textarea>
                <div id="caption-suggestions"></div>
            </div>

            <!-- Content Pillar -->
            {% if post and post.content_pillar %}
            <div class="flex items-center space-x-2">
                <span class="text-xs text-gray-500 dark:text-gray-400">Pillar:</span>
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-[#2A2A2A] text-gray-600 dark:text-gray-300">
                    {{ post.content_pillar }}
                </span>
            </div>
            {% endif %}

            <!-- Creative Controls Tabs -->
            <div>
                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Creative Controls</label>
                <div class="flex border-b border-[#26A0D8]/20 dark:border-[#26A0D8]/40 mb-3 overflow-x-auto">
                    <button type="button" data-tab="model-tab"
                            onclick="switchTab(this, 'model-tab')"
                            class="tab-btn px-3 py-2 text-xs font-medium text-[#F18523] border-b-2 border-[#F18523] transition-colors whitespace-nowrap">
                        Model
                    </button>
                    <button type="button" data-tab="style-tab"
                            onclick="switchTab(this, 'style-tab')"
                            class="tab-btn px-3 py-2 text-xs font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-gray-600 dark:hover:text-gray-300 transition-colors whitespace-nowrap">
                        Style Preset
                    </button>
                    <button type="button" data-tab="mood-tab"
                            onclick="switchTab(this, 'mood-tab')"
                            class="tab-btn px-3 py-2 text-xs font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-gray-600 dark:hover:text-gray-300 transition-colors whitespace-nowrap">
                        Mood Board
                    </button>
                    <button type="button" data-tab="prompt-tab"
                            onclick="switchTab(this, 'prompt-tab')"
                            class="tab-btn px-3 py-2 text-xs font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-gray-600 dark:hover:text-gray-300 transition-colors whitespace-nowrap">
                        Full Prompt
                    </button>
                </div>

                <!-- Model Picker Tab (default) -->
                <div id="model-tab" class="tab-content">
                    {% with models=image_models, selected=current_model, field_name="model", picker_id="post-model-picker", show_provider=true %}
                        {% include "components/model_picker.html" %}
                    {% endwith %}
                </div>

                <!-- Style Preset Tab -->
                <div id="style-tab" class="tab-content hidden">
                    <input type="hidden" name="style_preset" value="{{ post.style_preset if post and post.style_preset else campaign.style_preset if campaign and campaign.style_preset else 'pop_art' }}">
                    <div class="grid grid-cols-3 gap-2">
                        {% set presets = [
                            ('pop_art', '&#127912;', 'Pop Art'),
                            ('minimalist', '&#9711;', 'Minimalist'),
                            ('corporate', '&#128188;', 'Corporate'),
                            ('ugc', '&#128241;', 'UGC'),
                            ('flat_lay', '&#128247;', 'Flat Lay'),
                            ('cinematic', '&#127909;', 'Cinematic')
                        ] %}
                        {% set current_style = post.style_preset if post and post.style_preset else campaign.style_preset if campaign and campaign.style_preset else 'pop_art' %}
                        {% for value, icon, label in presets %}
                        <div class="style-card cursor-pointer border-2 rounded-lg p-2.5 text-center transition-all hover:bg-gray-100 dark:hover:bg-[#2A2A2A]/50
                                    {{ 'border-[#F18523] bg-[#F18523]/5' if value == current_style else 'border-[#26A0D8]/20 dark:border-[#26A0D8]/40' }}"
                             data-style="{{ value }}"
                             onclick="selectEditorStyle(this, '{{ value }}')">
                            <div class="text-xl mb-0.5">{{ icon }}</div>
                            <p class="text-[10px] font-medium text-gray-600 dark:text-gray-300">{{ label }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Mood Board Tab -->
                <div id="mood-tab" class="tab-content hidden">
                    <div class="space-y-3">
                        <!-- Reference Images Grid -->
                        <div id="mood-refs" class="grid grid-cols-3 gap-2">
                            <!-- Populated by JS on tab open -->
                        </div>

                        <!-- Upload Area -->
                        <label class="flex flex-col items-center justify-center w-full py-4 border-2 border-dashed border-[#26A0D8]/20 dark:border-[#26A0D8]/40 rounded-lg cursor-pointer hover:border-gray-500 hover:bg-gray-100 dark:hover:bg-[#2A2A2A]/30 transition-colors">
                            <svg class="w-6 h-6 text-gray-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/>
                            </svg>
                            <span class="text-xs text-gray-500">Upload reference image</span>
                            <input type="file" id="mood-upload" accept="image/*" class="hidden"
                                   onchange="uploadMoodRef(this)">
                        </label>

                        <p class="text-[10px] text-gray-500">Reference images guide AI generation style. Used as input alongside your prompt.</p>
                    </div>
                </div>

                <!-- Full Prompt Tab -->
                <div id="prompt-tab" class="tab-content hidden">
                    <textarea name="custom_prompt" rows="4"
                              class="w-full px-3 py-2 bg-white dark:bg-[#141414] border border-[#26A0D8]/30 rounded-lg text-sm text-gray-900 dark:text-white placeholder-gray-400
                                     focus:outline-none focus:ring-2 focus:ring-[#F18523] focus:border-transparent transition-colors resize-none font-mono text-xs"
                              placeholder="Override the auto-generated prompt with a custom one...">{{ post.custom_prompt if post and post.custom_prompt else '' }}</textarea>
                    <div class="flex items-center justify-between mt-1">
                        <p class="text-[10px] text-gray-500">Leave empty to use auto-generated prompt from brand doc + style preset</p>
                        {% if post and post.id %}
                        <button type="button"
                                hx-post="{{ url_for('api.agent_enhance_prompt', post_id=post.id) }}"
                                hx-target="#prompt-enhanced"
                                hx-swap="innerHTML"
                                hx-indicator="#prompt-ai-spinner"
                                class="inline-flex items-center px-2 py-1 text-[10px] font-medium text-[#F18523] hover:text-white bg-[#F18523]/10 hover:bg-[#F18523]/20 rounded border border-[#F18523]/20 transition-colors flex-shrink-0 ml-2">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Enhance with AI
                            <span id="prompt-ai-spinner" class="htmx-indicator ml-1">
                                <span class="w-2.5 h-2.5 border border-[#F18523] border-t-transparent rounded-full animate-spin inline-block"></span>
                            </span>
                        </button>
                        {% endif %}
                    </div>
                    <div id="prompt-enhanced"></div>
                </div>
            </div>

            <!-- Resolved Image Prompt (Read-only) -->
            {% if post and post.image_prompt %}
            <div>
                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5">
                    Resolved Prompt
                    <span class="text-gray-600 normal-case">(read-only)</span>
                </label>
                <div class="px-3 py-2 bg-gray-50/50 dark:bg-[#0F0F0F]/50 border border-[#26A0D8]/20 dark:border-[#26A0D8]/40 rounded-lg text-xs text-gray-500 dark:text-gray-400 font-mono max-h-24 overflow-y-auto">
                    {{ post.image_prompt }}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap items-center gap-2 mt-5 pt-4 border-t border-[#26A0D8]/20 dark:border-[#26A0D8]/40">
            <!-- Save -->
            <button type="submit" name="action" value="save"
                    class="inline-flex items-center px-3 py-1.5 bg-gray-100 dark:bg-[#2A2A2A] hover:bg-gray-200 dark:hover:bg-[#2A2A2A]/80 text-gray-700 dark:text-gray-200 text-xs font-medium rounded-lg border border-[#26A0D8]/20 dark:border-[#26A0D8]/40 transition-colors">
                <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Save
            </button>

            <!-- Generate -->
            <button type="submit" name="action" value="generate"
                    hx-post="{{ url_for('generate.generate_for_day', campaign_id=campaign.id, day=day) }}"
                    hx-target="#editor-content"
                    hx-swap="innerHTML"
                    class="inline-flex items-center px-3 py-1.5 bg-[#F18523] hover:bg-[#D97218] text-white text-xs font-medium rounded-lg transition-all">
                <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Generate
                <span id="post-model-picker-price-badge" class="ml-1.5 px-1 py-0.5 bg-white/10 rounded text-[10px]">${{ '%.2f' | format(current_model_price) }}</span>
            </button>

            <div class="flex-1"></div>

            <!-- Approve -->
            <button type="submit" name="action" value="approve"
                    class="inline-flex items-center px-3 py-1.5 bg-green-600/10 hover:bg-green-600/20 text-green-400 text-xs font-medium rounded-lg border border-green-500/20 transition-colors
                           {{ 'opacity-50 cursor-not-allowed' if not (post and post.image_url) else '' }}"
                    {{ 'disabled' if not (post and post.image_url) else '' }}>
                <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                </svg>
                Approve
            </button>

            <!-- Reject -->
            <button type="submit" name="action" value="reject"
                    class="inline-flex items-center px-3 py-1.5 bg-red-600/10 hover:bg-red-600/20 text-red-400 text-xs font-medium rounded-lg border border-red-500/20 transition-colors
                           {{ 'opacity-50 cursor-not-allowed' if not (post and post.image_url) else '' }}"
                    {{ 'disabled' if not (post and post.image_url) else '' }}>
                <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v2a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2M17 4h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"/>
                </svg>
                Reject
            </button>
        </div>
    </form>

    <!-- Generation Status -->
    {% if status == 'generating' %}
    <div class="flex items-center space-x-3 p-3 bg-yellow-900/20 border border-yellow-700/30 rounded-lg"
         hx-get="{{ url_for('posts.get_post', campaign_id=campaign.id, day=day) }}"
         hx-trigger="every 3s"
         hx-target="#editor-content"
         hx-swap="innerHTML">
        <div class="w-5 h-5 border-2 border-yellow-500 border-t-transparent rounded-full animate-spin flex-shrink-0"></div>
        <div>
            <p class="text-xs font-medium text-yellow-300">Generating image...</p>
            <p class="text-[10px] text-yellow-400/60">This usually takes 10-30 seconds</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
    function switchTab(btn, tabId) {
        // Hide all tab contents
        document.querySelectorAll('#editor-content .tab-content').forEach(function(tc) {
            tc.classList.add('hidden');
        });
        // Show selected tab
        document.getElementById(tabId).classList.remove('hidden');
        // Update tab button styles
        document.querySelectorAll('#editor-content .tab-btn').forEach(function(tb) {
            tb.classList.remove('text-[#F18523]', 'border-[#F18523]');
            tb.classList.add('text-gray-400', 'border-transparent');
        });
        btn.classList.remove('text-gray-400', 'border-transparent');
        btn.classList.add('text-[#F18523]', 'border-[#F18523]');
    }

    function loadMoodRefs() {
        fetch('{{ url_for("api.list_references", campaign_id=campaign.id) }}')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var grid = document.getElementById('mood-refs');
                if (!grid) return;
                grid.innerHTML = '';
                (data.references || []).forEach(function(ref) {
                    var div = document.createElement('div');
                    div.className = 'relative group';
                    div.innerHTML = '<img src="' + ref.url + '" class="w-full aspect-square object-cover rounded-lg border border-[#26A0D8]/20 dark:border-[#26A0D8]/40">' +
                        '<button type="button" onclick="deleteMoodRef(' + ref.id + ', this)" ' +
                        'class="absolute top-1 right-1 w-5 h-5 bg-red-600/80 rounded-full text-white text-xs hidden group-hover:flex items-center justify-center">&times;</button>';
                    grid.appendChild(div);
                });
            });
    }

    function uploadMoodRef(input) {
        if (!input.files || !input.files[0]) return;
        var fd = new FormData();
        fd.append('file', input.files[0]);
        fd.append('purpose', 'mood');
        fetch('{{ url_for("api.upload_reference", campaign_id=campaign.id) }}', {
            method: 'POST',
            body: fd,
        }).then(function(r) { return r.json(); })
          .then(function(data) {
              if (data.status === 'ok') loadMoodRefs();
              input.value = '';
          });
    }

    function deleteMoodRef(refId, btn) {
        fetch('/api/references/' + refId + '/delete', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(function(r) { return r.json(); })
            .then(function() { loadMoodRefs(); });
    }

    // Load mood board refs when tab is opened
    document.addEventListener('click', function(e) {
        if (e.target && e.target.dataset && e.target.dataset.tab === 'mood-tab') {
            loadMoodRefs();
        }
    });

    function selectEditorStyle(el, style) {
        var input = el.closest('form') ?
            el.closest('form').querySelector('input[name="style_preset"]') :
            document.querySelector('#editor-content input[name="style_preset"]');
        if (input) input.value = style;

        document.querySelectorAll('#editor-content .style-card').forEach(function(card) {
            card.classList.remove('border-[#F18523]', 'bg-[#F18523]/5');
            card.classList.add('border-[#26A0D8]/20', 'dark:border-[#26A0D8]/40');
        });
        el.classList.remove('border-[#26A0D8]/20', 'dark:border-[#26A0D8]/40');
        el.classList.add('border-[#F18523]', 'bg-[#F18523]/5');
    }
</script>
