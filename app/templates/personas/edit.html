{% extends "base.html" %}
{% block title %}Edit ‚Äî {{ persona.name }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Back link -->
    <a href="{{ url_for('personas.index') }}"
       class="inline-flex items-center text-sm text-gray-500 dark:text-gray-400 hover:text-[#F18523] transition-colors mb-6">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        Back to Personas
    </a>

    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Edit Persona</h1>
        <p class="text-gray-500 dark:text-gray-400 mt-1">
            Update {{ persona.name }}'s settings. Changes take effect immediately on new scripts.
        </p>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-6 space-y-2">
        {% for category, message in messages %}
        <div class="px-4 py-3 rounded-lg text-sm
            {% if category == 'error' %}bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 border border-red-200 dark:border-red-800
            {% elif category == 'success' %}bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800
            {% else %}bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 border border-blue-200 dark:border-blue-800{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('personas.edit', persona_id=persona.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Section: Basics -->
        <div class="bg-white dark:bg-[#1E1E1E] border border-[#26A0D8]/20 dark:border-[#26A0D8]/40 rounded-xl p-6 space-y-5 mb-6">
            <div class="flex items-center space-x-2 mb-1">
                <span class="text-lg">üë§</span>
                <h2 class="text-base font-semibold text-gray-900 dark:text-white">Basics</h2>
            </div>

            <!-- Persona Name -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Persona Name <span class="text-red-500">*</span>
                </label>
                <input type="text" id="name" name="name" required
                       value="{{ persona.name }}"
                       class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-[#141414] border border-[#26A0D8]/30 dark:border-[#26A0D8]/20 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#F18523]/50 focus:border-[#F18523] text-sm transition-colors">
            </div>

            <!-- Bio -->
            <div>
                <label for="bio" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    About You / Your Brand
                </label>
                <textarea id="bio" name="bio" rows="3"
                          placeholder="A short intro about you or your brand..."
                          class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-[#141414] border border-[#26A0D8]/30 dark:border-[#26A0D8]/20 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#F18523]/50 focus:border-[#F18523] text-sm transition-colors resize-none">{{ persona.bio or '' }}</textarea>
            </div>

            <!-- Industry -->
            <div>
                <label for="industry" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Industry
                </label>
                <input type="text" id="industry" name="industry"
                       value="{{ persona.industry or '' }}"
                       placeholder="e.g. SaaS, E-commerce, Fitness"
                       class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-[#141414] border border-[#26A0D8]/30 dark:border-[#26A0D8]/20 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#F18523]/50 focus:border-[#F18523] text-sm transition-colors">
                <div class="mt-2 flex flex-wrap gap-1.5">
                    {% for sug in ['SaaS', 'E-commerce', 'Fitness', 'Real Estate', 'Education', 'Health & Wellness', 'Fashion', 'Finance', 'Food & Beverage', 'Tech Startups'] %}
                    <button type="button"
                            onclick="document.getElementById('industry').value='{{ sug }}'"
                            class="text-[11px] px-2 py-1 rounded-full border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-[#2A2A2A] text-gray-500 dark:text-gray-400 hover:border-[#F18523]/50 hover:text-[#F18523] transition-colors cursor-pointer">
                        {{ sug }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Target Audience -->
            <div>
                <label for="target_audience" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Who do you talk to?
                </label>
                <textarea id="target_audience" name="target_audience" rows="2"
                          placeholder="Describe your audience..."
                          class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-[#141414] border border-[#26A0D8]/30 dark:border-[#26A0D8]/20 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#F18523]/50 focus:border-[#F18523] text-sm transition-colors resize-none">{{ persona.target_audience or '' }}</textarea>
            </div>
        </div>

        <!-- Section: Voice & Tone -->
        <div class="bg-white dark:bg-[#1E1E1E] border border-[#26A0D8]/20 dark:border-[#26A0D8]/40 rounded-xl p-6 space-y-5 mb-6">
            <div class="flex items-center space-x-2 mb-1">
                <span class="text-lg">üéôÔ∏è</span>
                <h2 class="text-base font-semibold text-gray-900 dark:text-white">Voice & Tone</h2>
            </div>

            <!-- Tone Picker -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Tone
                </label>
                <input type="hidden" id="tone" name="tone" value="{{ persona.tone or '' }}">
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    {% for t in [
                        {'val': 'Casual & Friendly', 'emoji': 'üòä', 'desc': 'Like texting a friend'},
                        {'val': 'Professional', 'emoji': 'üíº', 'desc': 'Polished, corporate-safe'},
                        {'val': 'Bold & Energetic', 'emoji': 'üî•', 'desc': 'High energy, motivational'},
                        {'val': 'Warm & Empathetic', 'emoji': 'üíõ', 'desc': 'Understanding, supportive'},
                        {'val': 'Witty & Humorous', 'emoji': 'üòÑ', 'desc': 'Fun, makes people smile'},
                        {'val': 'Authoritative', 'emoji': 'üéØ', 'desc': 'Expert, commanding trust'},
                        {'val': 'Inspirational', 'emoji': '‚ú®', 'desc': 'Uplifting, dream-big energy'},
                        {'val': 'Conversational', 'emoji': 'üí¨', 'desc': 'Natural, like a podcast'},
                        {'val': 'Edgy & Raw', 'emoji': 'üñ§', 'desc': 'Unfiltered, no-BS honesty'}
                    ] %}
                    <button type="button"
                            onclick="selectTone(this, '{{ t.val }}')"
                            class="tone-chip p-3 rounded-lg border text-left hover:border-[#F18523]/50 transition-all cursor-pointer
                                {% if persona.tone == t.val %}border-[#F18523] bg-[#F18523]/5 dark:bg-[#F18523]/10 ring-1 ring-[#F18523]/30
                                {% else %}border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-[#2A2A2A]{% endif %}">
                        <div class="text-lg mb-0.5">{{ t.emoji }}</div>
                        <div class="text-xs font-medium text-gray-700 dark:text-gray-300">{{ t.val }}</div>
                        <div class="text-[10px] text-gray-400 dark:text-gray-500">{{ t.desc }}</div>
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Voice Style -->
            <div>
                <label for="voice_style" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Describe Your Voice
                </label>
                <textarea id="voice_style" name="voice_style" rows="3"
                          placeholder="How do you naturally write or speak?"
                          class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-[#141414] border border-[#26A0D8]/30 dark:border-[#26A0D8]/20 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#F18523]/50 focus:border-[#F18523] text-sm transition-colors resize-none">{{ persona.voice_style or '' }}</textarea>
            </div>

            <!-- Sample Phrases -->
            <div>
                <label for="sample_phrases" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Phrases You Actually Say
                </label>
                <textarea id="sample_phrases" name="sample_phrases" rows="3"
                          placeholder="One per line..."
                          class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-[#141414] border border-[#26A0D8]/30 dark:border-[#26A0D8]/20 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#F18523]/50 focus:border-[#F18523] text-sm transition-colors resize-none">{{ persona.sample_phrases | join('\n') if persona.sample_phrases else '' }}</textarea>
                <p class="mt-1 text-xs text-gray-400 dark:text-gray-500">One per line.</p>
            </div>
        </div>

        <!-- Section: Fine-Tune -->
        <div class="bg-white dark:bg-[#1E1E1E] border border-[#26A0D8]/20 dark:border-[#26A0D8]/40 rounded-xl p-6 space-y-5 mb-6">
            <div class="flex items-center space-x-2 mb-1">
                <span class="text-lg">üéõÔ∏è</span>
                <h2 class="text-base font-semibold text-gray-900 dark:text-white">Fine-Tune</h2>
            </div>

            <!-- Brand Keywords -->
            <div>
                <label for="brand_keywords" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Words You Love
                </label>
                <input type="text" id="brand_keywords" name="brand_keywords"
                       value="{{ persona.brand_keywords | join(', ') if persona.brand_keywords else '' }}"
                       placeholder="Comma-separated keywords..."
                       class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-[#141414] border border-[#26A0D8]/30 dark:border-[#26A0D8]/20 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#F18523]/50 focus:border-[#F18523] text-sm transition-colors">
            </div>

            <!-- Avoid Words -->
            <div>
                <label for="avoid_words" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Words to Never Use
                </label>
                <input type="text" id="avoid_words" name="avoid_words"
                       value="{{ persona.avoid_words | join(', ') if persona.avoid_words else '' }}"
                       placeholder="Comma-separated words to avoid..."
                       class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-[#141414] border border-[#26A0D8]/30 dark:border-[#26A0D8]/20 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#F18523]/50 focus:border-[#F18523] text-sm transition-colors">
            </div>

            <!-- Writing Guidelines -->
            <div>
                <label for="writing_guidelines" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Writing Rules
                </label>
                <textarea id="writing_guidelines" name="writing_guidelines" rows="3"
                          placeholder="Dos and don'ts for the AI..."
                          class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-[#141414] border border-[#26A0D8]/30 dark:border-[#26A0D8]/20 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#F18523]/50 focus:border-[#F18523] text-sm transition-colors resize-none">{{ persona.writing_guidelines or '' }}</textarea>
            </div>
        </div>

        <!-- AI Summary Preview -->
        {% if persona.ai_prompt_summary %}
        <div class="bg-gray-50 dark:bg-[#141414] border border-gray-200 dark:border-gray-700 rounded-xl p-5 mb-6">
            <div class="flex items-center space-x-2 mb-3">
                <span class="text-sm">ü§ñ</span>
                <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300">What the AI sees</h3>
            </div>
            <pre class="text-xs text-gray-500 dark:text-gray-400 whitespace-pre-wrap font-mono leading-relaxed">{{ persona.ai_prompt_summary }}</pre>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="flex items-center justify-between">
            <a href="{{ url_for('personas.index') }}"
               class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
                Cancel
            </a>
            <button type="submit"
                    class="inline-flex items-center px-6 py-2.5 bg-[#F18523] hover:bg-[#D97218] text-white text-sm font-medium rounded-lg transition-colors shadow-lg shadow-[#F18523]/20">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Save Changes
            </button>
        </div>
    </form>
</div>

<script>
function selectTone(el, value) {
    document.querySelectorAll('.tone-chip').forEach(chip => {
        chip.classList.remove('border-[#F18523]', 'bg-[#F18523]/5', 'dark:bg-[#F18523]/10', 'ring-1', 'ring-[#F18523]/30');
        chip.classList.add('border-gray-200', 'dark:border-gray-600', 'bg-gray-50', 'dark:bg-[#2A2A2A]');
    });
    el.classList.remove('border-gray-200', 'dark:border-gray-600', 'bg-gray-50', 'dark:bg-[#2A2A2A]');
    el.classList.add('border-[#F18523]', 'bg-[#F18523]/5', 'dark:bg-[#F18523]/10', 'ring-1', 'ring-[#F18523]/30');
    document.getElementById('tone').value = value;
}
</script>
{% endblock %}
