{# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
{#  AI Content Editor â€” inline chat-style refinement panel                 #}
{#  Injected per text-output block; uses /api/recipes/chat via fetch()     #}
{# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}

<div id="editor-panel-{{ idx }}"
     class="hidden mt-4 border-2 border-[#26A0D8]/30 dark:border-[#26A0D8]/50 rounded-xl bg-white dark:bg-[#1E1E1E] overflow-hidden transition-all"
     data-editor-idx="{{ idx }}">

    {# â”€â”€ Header â”€â”€ #}
    <div class="flex items-center justify-between px-5 py-3 bg-[#26A0D8]/5 dark:bg-[#26A0D8]/10 border-b border-[#26A0D8]/20">
        <div class="flex items-center space-x-2">
            <svg class="w-5 h-5 text-[#26A0D8]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
            </svg>
            <h4 class="text-sm font-semibold text-gray-900 dark:text-white">AI Editor</h4>
        </div>
        <button onclick="toggleEditor({{ idx }})"
                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                title="Close editor">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>

    {# â”€â”€ Context selectors (brand / persona) â”€â”€ #}
    <div class="flex items-center gap-3 px-5 py-3 bg-gray-50/50 dark:bg-[#141414]/50 border-b border-gray-100 dark:border-gray-800">
        <div class="flex-1">
            <label class="block text-[10px] uppercase tracking-wider text-gray-400 dark:text-gray-500 mb-1 font-semibold">Brand</label>
            <select id="editor-brand-{{ idx }}"
                    class="w-full text-xs rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-[#1E1E1E] text-gray-700 dark:text-gray-300 py-1.5 px-2 focus:ring-1 focus:ring-[#26A0D8]">
                <option value="">No brand context</option>
                {% for b in editor_brands %}
                <option value="{{ b.id }}" {% if b.is_active %}selected{% endif %}>{{ b.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex-1">
            <label class="block text-[10px] uppercase tracking-wider text-gray-400 dark:text-gray-500 mb-1 font-semibold">Persona</label>
            <select id="editor-persona-{{ idx }}"
                    class="w-full text-xs rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-[#1E1E1E] text-gray-700 dark:text-gray-300 py-1.5 px-2 focus:ring-1 focus:ring-[#26A0D8]">
                <option value="">No persona context</option>
                {% for p in editor_personas %}
                <option value="{{ p.id }}" {% if run.persona_id == p.id %}selected{% endif %}>{{ p.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    {# â”€â”€ Editable content area â”€â”€ #}
    <div class="px-5 pt-4">
        <label class="block text-[10px] uppercase tracking-wider text-gray-400 dark:text-gray-500 mb-1 font-semibold">Content (editable)</label>
        <textarea id="editor-content-{{ idx }}"
                  rows="10"
                  class="w-full rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-[#141414] text-sm text-gray-800 dark:text-gray-200 p-3 font-mono leading-relaxed resize-y focus:ring-2 focus:ring-[#26A0D8] focus:border-transparent"
                  placeholder="Content will appear hereâ€¦"></textarea>
    </div>

    {# â”€â”€ Chat history (appended dynamically) â”€â”€ #}
    <div id="editor-history-{{ idx }}" class="px-5 space-y-2 max-h-60 overflow-y-auto"></div>

    {# â”€â”€ AI explanation badge (shown after each edit) â”€â”€ #}
    <div id="editor-explanation-{{ idx }}" class="hidden px-5 py-2">
        <div class="flex items-start space-x-2 p-3 bg-[#26A0D8]/5 dark:bg-[#26A0D8]/10 rounded-lg border border-[#26A0D8]/20">
            <svg class="w-4 h-4 text-[#26A0D8] flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p id="editor-explanation-text-{{ idx }}" class="text-xs text-[#26A0D8] leading-relaxed"></p>
        </div>
    </div>

    {# â”€â”€ Quick action chips â”€â”€ #}
    <div class="px-5 pt-2 flex flex-wrap gap-1.5">
        <button onclick="editorQuickAction({{ idx }}, 'Make it more concise')"
                class="text-[11px] px-2.5 py-1 bg-gray-100 dark:bg-[#2A2A2A] text-gray-600 dark:text-gray-400 rounded-full hover:bg-[#26A0D8]/10 hover:text-[#26A0D8] transition-colors">
            âœ‚ï¸ Concise
        </button>
        <button onclick="editorQuickAction({{ idx }}, 'Make it more engaging and punchy')"
                class="text-[11px] px-2.5 py-1 bg-gray-100 dark:bg-[#2A2A2A] text-gray-600 dark:text-gray-400 rounded-full hover:bg-[#26A0D8]/10 hover:text-[#26A0D8] transition-colors">
            ğŸ”¥ Punchy
        </button>
        <button onclick="editorQuickAction({{ idx }}, 'Add a compelling call-to-action')"
                class="text-[11px] px-2.5 py-1 bg-gray-100 dark:bg-[#2A2A2A] text-gray-600 dark:text-gray-400 rounded-full hover:bg-[#26A0D8]/10 hover:text-[#26A0D8] transition-colors">
            ğŸ“£ Add CTA
        </button>
        <button onclick="editorQuickAction({{ idx }}, 'Make the tone more professional and formal')"
                class="text-[11px] px-2.5 py-1 bg-gray-100 dark:bg-[#2A2A2A] text-gray-600 dark:text-gray-400 rounded-full hover:bg-[#26A0D8]/10 hover:text-[#26A0D8] transition-colors">
            ğŸ‘” Professional
        </button>
        <button onclick="editorQuickAction({{ idx }}, 'Make the tone more casual and friendly')"
                class="text-[11px] px-2.5 py-1 bg-gray-100 dark:bg-[#2A2A2A] text-gray-600 dark:text-gray-400 rounded-full hover:bg-[#26A0D8]/10 hover:text-[#26A0D8] transition-colors">
            ğŸ˜Š Casual
        </button>
        <button onclick="editorQuickAction({{ idx }}, 'Fix any grammar, spelling, and formatting issues')"
                class="text-[11px] px-2.5 py-1 bg-gray-100 dark:bg-[#2A2A2A] text-gray-600 dark:text-gray-400 rounded-full hover:bg-[#26A0D8]/10 hover:text-[#26A0D8] transition-colors">
            âœ… Fix grammar
        </button>
        <button onclick="editorQuickAction({{ idx }}, 'Optimize for SEO â€” add keywords, improve headings, add a meta description')"
                class="text-[11px] px-2.5 py-1 bg-gray-100 dark:bg-[#2A2A2A] text-gray-600 dark:text-gray-400 rounded-full hover:bg-[#26A0D8]/10 hover:text-[#26A0D8] transition-colors">
            ğŸ” SEO
        </button>
    </div>

    {# â”€â”€ Chat input â”€â”€ #}
    <div class="px-5 py-4">
        <div class="flex items-end space-x-2">
            <div class="flex-1 relative">
                <textarea id="editor-input-{{ idx }}"
                          rows="2"
                          class="w-full rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-[#1E1E1E] text-sm text-gray-800 dark:text-gray-200 p-3 pr-12 resize-none focus:ring-2 focus:ring-[#26A0D8] focus:border-transparent"
                          placeholder="Tell the AI what to changeâ€¦ e.g. 'make it punchier' or 'add statistics'"
                          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendEditorChat({{ idx }});}"></textarea>
            </div>
            <button id="editor-send-{{ idx }}"
                    onclick="sendEditorChat({{ idx }})"
                    class="flex-shrink-0 inline-flex items-center justify-center w-10 h-10 bg-[#F18523] hover:bg-[#D97218] text-white rounded-lg transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                    title="Send">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
            </button>
        </div>
    </div>

    {# â”€â”€ Loading indicator â”€â”€ #}
    <div id="editor-loading-{{ idx }}" class="hidden px-5 pb-4">
        <div class="flex items-center space-x-2 text-sm text-[#F18523]">
            <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            <span>AI is editingâ€¦</span>
        </div>
    </div>
</div>
